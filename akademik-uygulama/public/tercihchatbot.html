<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Ãœniversite Tercih AsistanÄ±</title>
  <style>
  body {
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 10px;
    background-color: #ece5dd;
  }

  #chatContainer {
    width: 100%;
    max-width: 500px;
  }

  #chat {
    border: none;
    padding: 15px;
    height: 450px;
    overflow-y: auto;
    background-color: #ffffff;
    margin-bottom: 10px;
    border-radius: 16px;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  #inputArea {
    display: flex;
    width: 100%;
    gap: 8px;
  }

  input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 20px;
    font-size: 14px;
  }

  button {
    padding: 10px 16px;
    border: none;
    background-color: #25d366;
    color: white;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button:hover {
    background-color: #20c05c;
  }

  .bot, .user {
    max-width: 70%;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 14px;
    line-height: 1.3;
    word-wrap: break-word;
  }

  .bot {
    background-color: #dcf8c6;
    align-self: flex-start;
    color: #000;
  }

  .user {
    background-color: #34b7f1;
    color: white;
    align-self: flex-end;
  }

  a {
    color: #075e54;
    text-decoration: underline;
  }

  a:hover {
    color: #128c7e;
  }
</style>
</head>

<body>

<div id="chatContainer">
  <h1 style="text-align: center;">ğŸ“ Ãœniversite Tercih AsistanÄ±</h1>

  <div id="chat">
    <div class="bot">ğŸ“ HoÅŸ geldin!<br>ğŸ¤– Sohbete baÅŸlayabilirsin. (Ã‡Ä±kmak iÃ§in: q / SÄ±fÄ±rlamak iÃ§in: reset)</div>
  </div>

  <div id="inputArea">
    <input type="text" id="userInput" placeholder="MesajÄ±nÄ± yaz..." onkeypress="handleKeyPress(event)">
    <button onclick="sendUserMessage()">GÃ¶nder</button>
  </div>
</div>

<script>
let state = "start";
let session = {};

// Harf harf yazdÄ±rma fonksiyonu
function addMessage(text, sender, typing = false) {
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = sender;
  chat.appendChild(div);

  if (typing && sender === "bot") {
    let index = 0;
    function type() {
      if (index < text.length) {
        div.innerHTML += text[index];
        index++;
        setTimeout(type, 20);
        chat.scrollTop = chat.scrollHeight;
      }
    }
    type();
  } else {
    div.innerHTML = text;
    chat.scrollTop = chat.scrollHeight;
  }
}

function handleKeyPress(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    sendUserMessage();
  }
}

function sendUserMessage() {
  const input = document.getElementById("userInput");
  const message = input.value.trim();
  if (!message) return;

  addMessage(message, "user", false);
  input.value = "";
  handleConversation(message.toLowerCase());
}

function handleConversation(message) {
  if (message === "q" || message === "quit") {
    addMessage("ğŸ‘‹ GÃ¶rÃ¼ÅŸmek Ã¼zere!", "bot", true);
    state = "end";
    return;
  }

  if (message === "reset") {
    session = {};
    addMessage("ğŸ”„ HafÄ±za sÄ±fÄ±rlandÄ±! Hadi baÅŸtan baÅŸlayalÄ±m. âœ¨", "bot", true);
    state = "start";
    return;
  }

  if (state === "start") {
    addMessage("ğŸ¯ Merhaba! Ãœniversite tercihlerinde yardÄ±mcÄ± olmamÄ± ister misin?", "bot", true);
    state = "awaiting_permission";
    return;
  }

  if (state === "awaiting_permission") {
    if (message.includes("evet")) {
      addMessage("ğŸ“š Hadi baÅŸlayalÄ±m! Ã–ncelikle sÄ±nava girdin mi? (Evet / HayÄ±r)", "bot", true);
      state = "awaiting_exam";
    } else if (message.includes("hayÄ±r")) {
      addMessage("ğŸ‘‹ Pekala, sana ÅŸimdilik veda ediyorum. Ä°yi gÃ¼nler dilerim!", "bot", true);
      state = "end";
    } else {
      addMessage("â“ Ãœniversite tercihi yapmak ister misin? (Evet / HayÄ±r)", "bot", true);
    }
    return;
  }

  if (state === "awaiting_exam") {
    if (message.includes("evet")) {
      session["sinava_girdi"] = true;
      addMessage("ğŸ“ˆ Harika! Åimdi hangi puan tÃ¼rÃ¼yle sÄ±nava girdiÄŸini Ã¶ÄŸrenelim. (SAY, EA, SÃ–Z, DÄ°L)", "bot", true);
      state = "awaiting_score_type";
    } else if (message.includes("hayÄ±r")) {
      session["sinava_girdi"] = false;
      addMessage("ğŸ§  O zaman hangi alanlara ilgin olduÄŸunu Ã¶ÄŸrenelim. (Ã–rn: Bilgisayar, Hukuk, Ã–ÄŸretmenlik)", "bot", true);
      state = "awaiting_interest";
    } else {
      addMessage("â“ SÄ±nava girdin mi? LÃ¼tfen sadece 'Evet' veya 'HayÄ±r' yaz.", "bot", true);
    }
    return;
  }

  if (state === "awaiting_score_type") {
    session["puan_turu"] = message.toUpperCase();
    addMessage("ğŸ… Åimdi baÅŸarÄ± sÄ±ranÄ± Ã¶ÄŸrenelim. (Ã–rn: 25000 gibi)", "bot", true);
    state = "awaiting_rank";
    return;
  }

  if (state === "awaiting_rank") {
    session["siralama"] = message;
    addMessage("ğŸ§  Peki, hangi bÃ¶lÃ¼mlere ilgin var? (Ã–rn: Bilgisayar, Hukuk, Ã–ÄŸretmenlik)", "bot", true);
    state = "awaiting_interest";
    return;
  }

  if (state === "awaiting_interest") {
    session["ilgi_alani"] = message;
    addMessage("ğŸ“ Tercih etmek istediÄŸin ÅŸehir(ler) var mÄ±? (Ã–rn: Ä°stanbul, Ankara veya 'yok')", "bot", true);
    state = "awaiting_city";
    return;
  }

  if (state === "awaiting_city") {
    session["sehirler"] = message.toLowerCase() === "yok" ? "yok" : message.split(",");
    sendSessionToBackend();
    state = "awaiting_university_detail";
    return;
  }

  if (state === "awaiting_university_detail") {
    findUniversityDetails(message);
    return;
  }
}

async function sendSessionToBackend() {
  addMessage("ğŸ” Sana en uygun bÃ¶lÃ¼mleri arÄ±yorum, bir saniye... ğŸš€", "bot", true);

  const toSend = {
    message: JSON.stringify({
      sÄ±nava_girdi: session.sinava_girdi,
      puan_turu: session.puan_turu,
      ilgi_alani: session.ilgi_alani,
      siralama: session.siralama,
      sehirler: session.sehirler
    })
  };

  try {
    const response = await fetch("analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(toSend)
    });

    const data = await response.json();

    if (data.error) {
      addMessage(`âš ï¸ Hata: ${data.error}`, "bot", true);
      return;
    }

    if (data.tercihler.length === 0) {
      addMessage("ğŸ˜” ÃœzgÃ¼nÃ¼m, sana uygun bÃ¶lÃ¼m bulamadÄ±m.", "bot", true);
    } else {
      data.tercihler.forEach(item => {
        addMessage(`
          <b>ğŸ“ ${item.Ã¼niversite}</b><br>
          ğŸ“š ${item.bÃ¶lÃ¼m} (${item.ÅŸehir})<br>
          ğŸ¯ SÄ±ralama: ${item.sÄ±ralama} | ğŸ“Š Puan: ${item.puan} | ğŸ“ Burs: ${item.burs}<br>
          ${item.video_link ? `ğŸ¥ <a href="${item.video_link}" target="_blank">TanÄ±tÄ±m Videosu</a> | ` : ""}
          ğŸŒ <a href="${item.web_site}" target="_blank">Web Sitesi</a>
        `, "bot", false);
      });
    }

    addMessage("ğŸ’¬ DetaylÄ± bilgi almak istediÄŸin bir Ã¼niversite ismi yazabilir misin?", "bot", true);
  } catch (error) {
    addMessage(`âš ï¸ Ä°stek gÃ¶nderilemedi: ${error.message}`, "bot", true);
  }
}

async function findUniversityDetails(universityName) {
  try {
    const response = await fetch("university-detail", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: universityName })
    });

    const data = await response.json();

    if (data.error) {
      addMessage(`â— ${data.error}`, "bot", true);
      return;
    }

    if (data.universiteler) {
      data.universiteler.forEach(u => {
        addMessage(`
          <div class="card">
            ğŸ“š <b>${u.name}</b><br>
            ğŸ“ Adres: ${u.address}<br>
            ğŸ“ Telefon: ${u.phone}<br>
            ğŸ“  Fax: ${u.fax}<br>
            âœ‰ï¸ E-posta: ${u.email}<br>
            ğŸŒ <a class="button-link" href="${u.web}" target="_blank">Web Sitesi</a><br>
            ğŸ‘¨â€ğŸ“ RektÃ¶r: ${u.warden}
          </div>
        `, "bot", false);
      });
    } else {
      addMessage(`
        <div class="card">
          ğŸ“š <b>${data.name}</b><br>
          ğŸ“ Adres: ${data.address}<br>
          ğŸ“ Telefon: ${data.phone}<br>
          ğŸ“  Fax: ${data.fax}<br>
          âœ‰ï¸ E-posta: ${data.email}<br>
          ğŸŒ <a class="button-link" href="${data.web}" target="_blank">Web Sitesi</a><br>
          ğŸ‘¨â€ğŸ“ RektÃ¶r: ${data.warden}
        </div>
      `, "bot", false);
    }
  } catch (error) {
    addMessage(`âš ï¸ Detaylar getirilemedi: ${error.message}`, "bot", true);
  }
}

</script>

</body>
</html>
