<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Ãœniversite Tercih AsistanÄ±</title>
  <style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(to right, #f3e5f5, #e3f2fd);
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
  }

  #chatContainer {
    width: 100%;
    max-width: 600px;
    background: linear-gradient(to right, #f3e5f5, #e3f2fd);
    padding: 24px;
    border-radius: 20px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  h1 {
    text-align: center;
    color: #6a1b9a;
    font-size: 22px;
    margin-bottom: 0;
  }

  #chat {
    border: none;
    padding: 15px;
    height: 420px;
    overflow-y: auto;
    background-color: #fafafa;
    border-radius: 16px;
    box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  #inputArea {
    display: flex;
    width: 100%;
    gap: 10px;
  }

  input {
    flex-grow: 1;
    padding: 10px 14px;
    border: 1px solid #ccc;
    border-radius: 20px;
    font-size: 14px;
  }

  button {
    padding: 10px 16px;
    border: none;
    background-color: #8e24aa;
    color: white;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button:hover {
    background-color: #967ea4;
  }

  .bot, .user {
    max-width: 75%;
    padding: 10px 14px;
    border-radius: 20px;
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  }

  .bot {
    background-color: #e1bee7;
    align-self: flex-start;
    color: #111;
  }

  .user {
    background-color: #8e24aa;
    color: white;
    align-self: flex-end;
  }

  a {
    color: #4a148c;
    text-decoration: underline;
  }

  a:hover {
    color: #6a1b9a;
  }

  .card {
  background: linear-gradient(to bottom right, #f3e5f5, #e8eaf6); /* pastel mor-mavi uyumu */
  border-radius: 16px;
  padding: 14px;
  margin: 10px 0;
  box-shadow: 0 2px 6px rgba(138, 43, 226, 0.1);
  font-size: 14px;
  color: #311b92;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(106, 27, 154, 0.18);
}


 .button-link {
  display: inline-block;
  margin-top: 8px;
  padding: 6px 12px;
  background-color: #8e24aa;
  color: #fff;
  font-weight: bold;
  border-radius: 12px;
  text-decoration: none;
  transition: background-color 0.3s ease;
}

.button-link:hover {
  background-color: #6a1b9a;
}

</style>

</head>

<body>

<div id="chatContainer">
  <h1 style="text-align: center;">ğŸ“ Ãœniversite Tercih AsistanÄ±</h1>

  <div id="chat">
    <div class="bot">ğŸ“ HoÅŸ geldin!<br>ğŸ¤– Sohbete baÅŸlayabilirsin. (Ã‡Ä±kmak iÃ§in: q / SÄ±fÄ±rlamak iÃ§in: reset)</div>
  </div>

  <div id="inputArea">
    <input type="text" id="userInput" placeholder="MesajÄ±nÄ± yaz..." onkeypress="handleKeyPress(event)">
    <button onclick="sendUserMessage()">GÃ¶nder</button>
  </div>
</div>

<script>
let state = "start";
let session = {};

// Harf harf yazdÄ±rma fonksiyonu
function addMessage(text, sender, typing = false) {
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = sender;

  if (typing && sender === "bot") {
    let index = 0;
    const tempSpan = document.createElement("span");
    div.appendChild(tempSpan);
    chat.appendChild(div);

    function type() {
      if (index < text.length) {
        tempSpan.innerHTML += text[index];
        index++;
        setTimeout(type, 20);
        chat.scrollTop = chat.scrollHeight;
      }
    }
    type();
  } else {
    div.innerHTML = text;  // HTML olarak yaz
    chat.appendChild(div); // DOM'a ekle
    chat.scrollTop = chat.scrollHeight;
  }
  
}


function handleKeyPress(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    sendUserMessage();
  }
}

function sendUserMessage() {
  const input = document.getElementById("userInput");
  const message = input.value.trim();
  if (!message) return;

  addMessage(message, "user", false);
  input.value = "";
  handleConversation(message.toLowerCase());
}

function handleConversation(message) {
  if (message === "q" || message === "quit") {
    addMessage("ğŸ‘‹ GÃ¶rÃ¼ÅŸmek Ã¼zere!", "bot", true);
    state = "end";
    return;
  }

  if (message === "reset") {
    session = {};
    addMessage("ğŸ”„ HafÄ±za sÄ±fÄ±rlandÄ±! Hadi baÅŸtan baÅŸlayalÄ±m. âœ¨", "bot", true);
    state = "start";
    return;
  }

  if (state === "start") {
    addMessage("ğŸ¯ Merhaba! Ãœniversite tercihlerinde yardÄ±mcÄ± olmamÄ± ister misin?", "bot", true);
    state = "awaiting_permission";
    return;
  }

  if (state === "awaiting_permission") {
    if (message.includes("evet")) {
      addMessage("ğŸ“š Hadi baÅŸlayalÄ±m! Ã–ncelikle sÄ±nava girdin mi? (Evet / HayÄ±r)", "bot", true);
      state = "awaiting_exam";
    } else if (message.includes("hayÄ±r")) {
      addMessage("ğŸ‘‹ Pekala, sana ÅŸimdilik veda ediyorum. Ä°yi gÃ¼nler dilerim!", "bot", true);
      state = "end";
    } else {
      addMessage("â“ Ãœniversite tercihi yapmak ister misin? (Evet / HayÄ±r)", "bot", true);
    }
    return;
  }

  if (state === "awaiting_exam") {
    if (message.includes("evet")) {
      session["sinava_girdi"] = true;
      addMessage("ğŸ“ˆ Harika! Åimdi hangi puan tÃ¼rÃ¼yle sÄ±nava girdiÄŸini Ã¶ÄŸrenelim. (SAY, EA, SÃ–Z, DÄ°L)", "bot", true);
      state = "awaiting_score_type";
    } else if (message.includes("hayÄ±r")) {
      session["sinava_girdi"] = false;
      addMessage("ğŸ§  O zaman hangi alanlara ilgin olduÄŸunu Ã¶ÄŸrenelim. (Ã–rn: Bilgisayar, Hukuk, Ã–ÄŸretmenlik)", "bot", true);
      state = "awaiting_interest";
    } else {
      addMessage("â“ SÄ±nava girdin mi? LÃ¼tfen sadece 'Evet' veya 'HayÄ±r' yaz.", "bot", true);
    }
    return;
  }

  if (state === "awaiting_score_type") {
    session["puan_turu"] = message.toUpperCase();
    addMessage("ğŸ… Åimdi baÅŸarÄ± sÄ±ranÄ± Ã¶ÄŸrenelim. (Ã–rn: 25000 gibi)", "bot", true);
    state = "awaiting_rank";
    return;
  }

  if (state === "awaiting_rank") {
    session["siralama"] = message;
    addMessage("ğŸ§  Peki, hangi bÃ¶lÃ¼mlere ilgin var? (Ã–rn: Bilgisayar, Hukuk, Ã–ÄŸretmenlik)", "bot", true);
    state = "awaiting_interest";
    return;
  }

  if (state === "awaiting_interest") {
    session["ilgi_alani"] = message;
    addMessage("ğŸ“ Tercih etmek istediÄŸin ÅŸehir(ler) var mÄ±? (Ã–rn: Ä°stanbul, Ankara veya 'yok')", "bot", true);
    state = "awaiting_city";
    return;
  }

  if (state === "awaiting_city") {
    session["sehirler"] = message.toLowerCase() === "yok" ? "yok" : message.split(",");
    sendSessionToBackend();
    state = "awaiting_university_detail";
    return;
  }

  if (state === "awaiting_university_detail") {
    findUniversityDetails(message);
    return;
  }
}

async function sendSessionToBackend() {
  addMessage("ğŸ” Sana en uygun bÃ¶lÃ¼mleri arÄ±yorum, bir saniye... ğŸš€", "bot", true);

  const toSend = {
    message: JSON.stringify({
      sÄ±nava_girdi: session.sinava_girdi,
      puan_turu: session.puan_turu,
      ilgi_alani: session.ilgi_alani,
      siralama: session.siralama,
      sehirler: session.sehirler
    })
  };

  try {
    const response = await fetch("/analyze/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(toSend)
    });

    const data = await response.json();

    if (data.error) {
      addMessage(`âš ï¸ Hata: ${data.error}`, "bot", true);
      return;
    }

    if (data.tercihler.length === 0) {
      addMessage("ğŸ˜” ÃœzgÃ¼nÃ¼m, sana uygun bÃ¶lÃ¼m bulamadÄ±m.", "bot", true);
    } else {
      data.tercihler.forEach(item => {
        const html = `
          <b>ğŸ“ ${item.Ã¼niversite}</b><br>
          ğŸ“š ${item.bÃ¶lÃ¼m} (${item.ÅŸehir})<br>
          ğŸ¯ SÄ±ralama: ${item.sÄ±ralama} | ğŸ“Š Puan: ${item.puan} | ğŸ“ Burs: ${item.burs}<br>
          ${item.video_link ? `ğŸ¥ <a href="${item.video_link}" target="_blank" rel="noopener noreferrer">TanÄ±tÄ±m Videosu</a> | ` : ""}
          ğŸŒ <a href="${item.web_site}" target="_blank" rel="noopener noreferrer">Web Sitesi</a>
        `;

        addMessage(html, "bot", false);

      });
    }

    addMessage("ğŸ’¬ DetaylÄ± bilgi almak istediÄŸin bir Ã¼niversite ismi yazabilir misin?", "bot", true);
  } catch (error) {
    addMessage(`âš ï¸ Ä°stek gÃ¶nderilemedi: ${error.message}`, "bot", true);
  }
}

async function findUniversityDetails(universityName) {
  try {
    const response = await fetch("/university-detail/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: universityName })
    });

    const data = await response.json();
    console.log("ğŸ§¾ Gelen veri:", data);

    // EÄŸer 'universiteler' listesi varsa
    if (data.universiteler && data.universiteler.length > 0) {
      data.universiteler.forEach(u => {
        addMessage(`
          <div class="card">
            ğŸ“š <b>${u.name}</b><br>
            ğŸ“ Adres: ${u.address}<br>
            ğŸ“ Telefon: ${u.phone}<br>
            ğŸ“  Fax: ${u.fax}<br>
            âœ‰ï¸ E-posta: ${u.email}<br>
            ğŸŒ <a class="button-link" href="${u.web}" target="_blank">Web Sitesi</a><br>
            ğŸ‘¨â€ğŸ“ RektÃ¶r: ${u.warden}
          </div>
        `, "bot", false);
      });
    }

    // EÄŸer tek bir nesne geldiyse (liste yoksa)
    else if (data.name) {
      addMessage(`
        <div class="card">
          ğŸ“š <b>${data.name}</b><br>
          ğŸ“ Adres: ${data.address}<br>
          ğŸ“ Telefon: ${data.phone}<br>
          ğŸ“  Fax: ${data.fax}<br>
          âœ‰ï¸ E-posta: ${data.email}<br>
          ğŸŒ <a class="button-link" href="${data.web}" target="_blank">Web Sitesi</a><br>
          ğŸ‘¨â€ğŸ“ RektÃ¶r: ${data.warden}
        </div>
      `, "bot", false);
    }

    // Ne liste ne obje gelmediyse
    else {
      addMessage("â— Ãœniversite bilgisi bulunamadÄ±.", "bot", true);
    }

  } catch (error) {
    addMessage(`âš ï¸ Detaylar getirilemedi: ${error.message}`, "bot", true);
  }
}

document.addEventListener("click", function (e) {
  const link = e.target.closest("a");
  if (link && link.target === "_blank") {
    e.preventDefault();
    window.open(link.href, "_blank");
  }
});

</script>

</body>
</html>
